<!-- File: templates/user_manager/search_results.html -->
{% extends 'main/base_with_navbar.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/components/slider.css'%}"/>
<link rel="stylesheet" type="text/css" href="{% static 'css/user_manager/style.css'%}"/>
<link rel="stylesheet" type="text/css" href="{% static 'css/socials/activity_page.css'%}"/>
<link rel="stylesheet" type="text/css" href="{% static 'css/socials/profile_page.css'%}"/>
<link rel="stylesheet" type="text/css" href="{% static 'css/user_manager/search_results.css'%}"/>
<div class="search-results-container">
<div class="tab-container">
    <div class="tab active" onclick="openTab(event, 'events')">Wydarzenia</div>
    <div class="tab" onclick="openTab(event, 'texts')">Wpisy</div>
    <div class="tab" onclick="openTab(event, 'users')">Użytkownicy</div>
</div>

<div id="events" class="tab-content active">
    {% if posts_events %}
    <div class="post-list">
        {% for post, is_post_liked_by_user, like_count, comment_count, is_author, is_shared in posts_events %}
        <div class="post box">
            <div class="user-additional-info"> {% if post.user.profile.location %}  <div class="user-info-box"> {{ post.user.profile.location }} </div> {% endif %} {% if post.user.is_superuser %}  <div class="user-info-box"> Admin </div> {% endif %} </div>
            <div class="post-topbar">
                <a href="/profil/{{post.user.profile.slug}}" class="post-topbar-user-avatar">
                    <img src="{{post.user.profile.avatar}}/thumb" alt="user avatar"/>
                </a>
                <div class="user-data">
                    <p>
                        {{post.user.first_name}} {{post.user.last_name}}
                    </p>
                    <p class="event-type"> {{ post.event.event_type  }} </p>
                </div>
            </div>
            {% if post.post_type == 'event' and post.event %}
            <div class="post-text">
                <h4 class="event-title">{{ post.event.title }}</h4>
                <p class="short-content">
                    {{ post.content|truncatechars:255 }}
                </p>
                <p class="full-content" style="display: none;">
                    {{ post.content }}
                </p>
                {% if post.content|char_count > 255 %}
                <button class="btn-continue-reading" onclick="toggleContent(this)">Pokaż więcej</button>
                {% endif %}

                <div class="post-assets">
                    {% with attachments=post.attachments.all %}
                    {% if attachments|length > 1 %}
                    <div class="carousel">
                        <div class="carousel-images">
                            {% for attachment in attachments %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                {% if attachment.type == 'photo' %}
                                <img src="{{ attachment.attachment_url }}/thumb" alt="Image {{ forloop.counter }}" class="post-img">
                                {% elif attachment.type == 'video' %}
                                <video controls class="post-video">
                                    <source src="{{ attachment.attachment_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="carousel-controls">
                            <button class="prev">❮</button>
                            <button class="next">❯</button>
                        </div>
                    </div>
                    {% elif attachments|length == 1 %}
                    {% with attachment=attachments.0 %}
                    <div class="carousel-item ">
                        {% if attachment.type == 'photo' %}
                        <img src="{{ attachment.attachment_url }}/thumb" alt="Image" class="post-img">
                        {% elif attachment.type == 'video' %}
                        <video controls class="post-video">
                            <source src="{{ attachment.attachment_url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        {% endif %}
                    </div>
                    {% endwith %}
                    {% endif %}
                    {% endwith %}

                </div>

                <div class="event-character">
                    <div class="event-character-box">
                        {{ post.event.when|date:"d.m.Y" }}
                        {% if post.event.date_end %}
                        - {{ post.event.date_end|date:"d.m.Y" }}
                        {% endif %}
                    </div>
                    <div class="event-character-box"> {{ post.event.where }}</div>
                    <div class="event-character-box">{{ post.event.price }} zł</div>
                    {% if post.event.number_of_people %}
                    <div class="event-character-box">Przewidywana liczba osób: {{ post.event.number_of_people }}</div>
                    {% endif %}
                </div>
            </div>

            {% else %}
            <div class="post-text">

                <p class="short-content">
                    {{ post.content|truncatechars:255 }}
                </p>
                <p class="full-content" style="display: none;">
                    {{ post.content }}
                </p>
                {% if post.content|char_count > 255 %}
                <button class="btn-continue-reading" onclick="toggleContent(this)">Pokaż więcej</button>
                {% endif %}

                <div class="post-assets">
                    {% with attachments=post.attachments.all %}
                    {% if attachments|length > 1 %}
                    <div class="carousel">
                        <div class="carousel-images">
                            {% for attachment in attachments %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                {% if attachment.type == 'photo' %}
                                <img src="{{ attachment.attachment_url }}/thumb" alt="Image {{ forloop.counter }}" class="post-img">
                                {% elif attachment.type == 'video' %}
                                <video controls class="post-video">
                                    <source src="{{ attachment.attachment_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="carousel-controls">
                            <button class="prev">❮</button>
                            <button class="next">❯</button>
                        </div>
                    </div>
                    {% elif attachments|length == 1 %}
                    {% with attachment=attachments.0 %}
                    <div class="carousel-item ">
                        {% if attachment.type == 'photo' %}
                        <img src="{{ attachment.attachment_url }}/thumb" alt="Image" class="post-img">
                        {% elif attachment.type == 'video' %}
                        <video controls class="post-video">
                            <source src="{{ attachment.attachment_url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        {% endif %}
                    </div>
                    {% endwith %}
                    {% endif %}
                    {% endwith %}

                </div>

            </div>
            {% endif %}

            <div class="hashtags">
                {% with post.hashtags|split:" " as hashtags_list %}
                {% for tag in hashtags_list %}
                <div class="tag-box"> {{tag}}</div>
                {% endfor %}
                {% endwith %}
            </div>
            <div class="actions-counter">
                <div class="avatars-counter">
                    {% if is_post_liked_by_user %}
                    <button class="avatars-counter like-post-button" data-post-id="{{ post.id }}" data-action="unlike">
                        {% else %}
                        <button class="avatars-counter like-post-button" data-post-id="{{ post.id }}" data-action="like">
                            {% endif %}
                            <p class="like-count">
                                {{ like_count }}
                            </p>
                            <span> <img src="{% static 'img/wyprawowo-avatar.png' %}" alt="wyprawowo avatar"/> </span>
                        </button>
                </div>
                <button class="comment-counter action-box"  data-post-id="{{ post.id }}">{{ comment_count }} odpowiedzi</button>

                {% if not is_author %}
                <a  class="action-box btn-share" href="{% url 'share_post' post.id %}">Udostępnij</a>
                {% endif %}
            </div>

            <div id="comments-section-wrapper-{{ post.id }}" class="comments-section-wrapper">

                {% if request.user.is_authenticated %}

                <form method="post" action="{% url 'create_post_comment' post_id=post.id %}" class="comment-form">
                    {% csrf_token %}
                    <textarea type="text" name="content_comment" class="comment-textarea" placeholder="Skomentuj" id="content_comment"></textarea>
                    <input type="submit" value="dodaj" class="btn-add-comment">
                </form>

                {% endif %}

                <div class="comments-section">
                    {% for comment in post.comments.all %}
                    <div class="comment-box">
                        <a href="/profil/{{comment.user.profile.slug}}">
                            <img src="{{comment.user.profile.avatar}}/thumb" alt="profile avatar"/>
                        </a>
                        <div>
                            <div class="user-additional-info"> {% if comment.user.profile.location %}  <div class="user-info-box"> {{ comment.user.profile.location }} </div> {% endif %} {% if comment.user.is_superuser %}  <div class="user-info-box"> Admin </div> {% endif %} </div>
                            <p class="comment-box-user">{{ comment.user.first_name }} {{ comment.user.last_name }}
                             </p>
                            <p class="comment-box-content">{{ comment.content }} </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>Brak wydarzeń pasujących do frazy "{{ query }}"</p>
    {% endif %}
</div>

<div id="texts" class="tab-content">
    {% if posts_texts %}
    <div class="post-list">
        {% for post, is_post_liked_by_user, like_count, comment_count, is_author, is_shared in posts_texts %}
        <div class="post box">
            <div class="user-additional-info"> {% if post.user.profile.location %}  <div class="user-info-box"> {{ post.user.profile.location }} </div> {% endif %} {% if post.user.is_superuser %}  <div class="user-info-box"> Admin </div> {% endif %} </div>
            <div class="post-topbar">
                <a href="/profil/{{post.user.profile.slug}}" class="post-topbar-user-avatar">
                    <img src="{{post.user.profile.avatar}}/thumb" alt="user avatar"/>
                </a>
                <div class="user-data">
                    <p>
                        {{post.user.first_name}} {{post.user.last_name}}
                    </p>
                    <p class="post-date">  {{ post.created_at|date:"d.m.Y"  }} </p>
                </div>
            </div>
            <div class="post-text">
                <h4 class="event-title">{{ post.event.title }}</h4>
                <p class="short-content">
                    {{ post.content|truncatechars:255 }}
                </p>
                <p class="full-content" style="display: none;">
                    {{ post.content }}
                </p>
                {% if post.content|char_count > 255 %}
                <button class="btn-continue-reading" onclick="toggleContent(this)">Pokaż więcej</button>
                {% endif %}

                <div class="post-assets">
                    {% with attachments=post.attachments.all %}
                    {% if attachments|length > 1 %}
                    <div class="carousel">
                        <div class="carousel-images">
                            {% for attachment in attachments %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                {% if attachment.type == 'photo' %}
                                <img src="{{ attachment.attachment_url }}/thumb" alt="Image {{ forloop.counter }}" class="post-img">
                                {% elif attachment.type == 'video' %}
                                <video controls class="post-video">
                                    <source src="{{ attachment.attachment_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="carousel-controls">
                            <button class="prev">❮</button>
                            <button class="next">❯</button>
                        </div>
                    </div>
                    {% elif attachments|length == 1 %}
                    {% with attachment=attachments.0 %}
                    <div class="carousel-item ">
                        {% if attachment.type == 'photo' %}
                        <img src="{{ attachment.attachment_url }}/thumb" alt="Image" class="post-img">
                        {% elif attachment.type == 'video' %}
                        <video controls class="post-video">
                            <source src="{{ attachment.attachment_url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        {% endif %}
                    </div>
                    {% endwith %}
                    {% endif %}
                    {% endwith %}

                </div>
            </div>

            <div class="hashtags">
                {% with post.hashtags|split:" " as hashtags_list %}
                {% for tag in hashtags_list %}
                <div class="tag-box"> {{tag}}</div>
                {% endfor %}
                {% endwith %}
            </div>
            <div class="actions-counter">
                <div class="avatars-counter">
                    {% if is_post_liked_by_user %}
                    <button class="avatars-counter like-post-button" data-post-id="{{ post.id }}" data-action="unlike">
                        {% else %}
                        <button class="avatars-counter like-post-button" data-post-id="{{ post.id }}" data-action="like">
                            {% endif %}
                            <p class="like-count">
                                {{ like_count }}
                            </p>
                            <span> <img src="{% static 'img/wyprawowo-avatar.png' %}" alt="wyprawowo avatar"/> </span>
                        </button>
                </div>
                <button class="comment-counter action-box"  data-post-id="{{ post.id }}">{{ comment_count }} odpowiedzi</button>

                {% if not is_author %}
                <a  class="action-box btn-share" href="{% url 'share_post' post.id %}">Udostępnij</a>
                {% endif %}
            </div>

            <div id="comments-section-wrapper-{{ post.id }}" class="comments-section-wrapper">

                {% if request.user.is_authenticated %}

                <form method="post" action="{% url 'create_post_comment' post_id=post.id %}" class="comment-form">
                    {% csrf_token %}
                    <textarea type="text" name="content_comment" class="comment-textarea" placeholder="Skomentuj" id="content_comment"></textarea>
                    <input type="submit" value="dodaj" class="btn-add-comment">
                </form>

                {% endif %}

                <div class="comments-section">
                    {% for comment in post.comments.all %}
                    <div class="comment-box">
                        <a href="/profil/{{comment.user.profile.slug}}">
                            <img src="{{comment.user.profile.avatar}}/thumb" alt="profile avatar"/>
                        </a>
                        <div>
                            <div class="user-additional-info"> {% if comment.user.profile.location %}  <div class="user-info-box"> {{ comment.user.profile.location }} </div> {% endif %} {% if comment.user.is_superuser %}  <div class="user-info-box"> Admin </div> {% endif %} </div>
                            <p class="comment-box-user">{{ comment.user.first_name }} {{ comment.user.last_name }}
                             </p>
                            <p class="comment-box-content">{{ comment.content }} </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>
        {% endfor %}

    </div>
    {% else %}
    <p>Brak postów pasujących do frazy "{{ query }}"</p>
    {% endif %}
</div>

<div id="users" class="tab-content">
    {% if profiles %}
    <div>
            {% for profile in profiles %}
        <a href="/profil/{{profile.slug}}">
            <div class="box user-box">
                <div class="user-box-top">
                    <img class="profile-avatar" src="{{profile.avatar}}/thumb"
                         alt="{{profile.user.first_name}}-avatar"/>
                    <div class="profile_data">
                        <p class="profile_name">
                            {{profile.user.first_name}} {{profile.user.last_name}}
                        </p>
                        <p class="avatar-number">
                            <img src="{% static 'img/wyprawowo-avatar.png' %}" alt="wyprawowo avatar"/>
                            99</p>
                    </div>
                </div>

                <p class="user-box-description"> {{profile.description}} </p>
            </div>
        </a>

            {% endfor %}
        </div>
    {% else %}
    <p>Brak użytkowników pasujących do frazy "{{ query }}"</p>
    {% endif %}
</div>
</div>

<script>
    const openTab = (event, tabId) => {
        const tabContents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].classList.remove("active");
        }

        const tabs = document.getElementsByClassName("tab");
        for (let i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove("active");
        }

        document.getElementById(tabId).classList.add("active");
        event.currentTarget.classList.add("active");
    }

    document.querySelectorAll('.like-post-button').forEach(button => {
        button.addEventListener('click', function () {
            const postId = this.getAttribute('data-post-id');
            const action = this.getAttribute('data-action');
            fetch(`/post/${postId}/${action}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                const likeCounter =  this.querySelector('p');
                if(action==='like'){
                    this.setAttribute('data-action', 'unlike')
                    likeCounter.textContent =  Number(likeCounter.textContent) + 1;
                }else{
                    this.setAttribute('data-action', 'like')
                    likeCounter.textContent =  Number(likeCounter.textContent) -1;
                }
            })
        });
    });

    const toggleContent = (button) => {
        const postTextDiv = button.parentElement;
        const shortContent = postTextDiv.querySelector('.short-content');
        const fullContent = postTextDiv.querySelector('.full-content');

        if (fullContent.style.display === 'none') {
            fullContent.style.display = 'block';
            shortContent.style.display = 'none';
            button.innerText = 'Pokaż mniej';
        } else {
            fullContent.style.display = 'none';
            shortContent.style.display = 'block';
            button.innerText = 'Pokaż więcej';
        }
    }
</script>
<script src="{% static 'js/activity_panel.js' %}" type="module"></script>

{% endblock %}
